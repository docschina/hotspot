# å†è§ JavaScript æ€§èƒ½åˆ†æå™¨ï¼Œä½¿ç”¨ â€œPerformanceâ€ é¢æ¿å¯¹ CPU è¿›è¡Œæ€§èƒ½åˆ†æ

**[åŸæ–‡é“¾æ¥](https://developer.chrome.com/blog/profiling-cpu?hl=zh-cn)**

> è¯‘æ³¨ï¼š**JavaScript æ€§èƒ½åˆ†æå™¨** å³ **JavaScript Profiler** é¢æ¿ï¼›**æ€§èƒ½**é¢æ¿å³ **Performance** é¢æ¿

Chrome 124 å³å°†åœç”¨ Â **JavaScript æ€§èƒ½åˆ†æå™¨**é¢æ¿ã€‚ä»Šåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**æ€§èƒ½**é¢æ¿åˆ†æ Node.js CPU æ€§èƒ½ã€‚

## æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å¼ƒç”¨ JavaScript æ€§èƒ½åˆ†æå™¨ï¼Ÿ

æ—©åœ¨ Chrome 58 æ—¶ï¼Œå¼€å‘è€…å·¥å…·å›¢é˜Ÿå°±è®¡åˆ’æœ€ç»ˆå¼ƒç”¨ **JavaScript æ€§èƒ½åˆ†æå™¨**ã€‚æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š

- **å®ƒç›®å‰å·²ä¸å†å¤„äºç§¯æå¼€å‘é˜¶æ®µ**ã€‚**JavaScript æ€§èƒ½åˆ†æå™¨**å·²ç»å‡ å¹´æ²¡æœ‰æ”¶åˆ°ä»»ä½•é‡å¤§æ›´æ–°ï¼Œå›¢é˜Ÿä¹Ÿæ²¡æœ‰ç»§ç»­å¼€å‘å®ƒçš„èµ„æºã€‚
- **æ›´é¡ºç•…çš„åˆ†æä½“éªŒ**ã€‚**æ€§èƒ½**é¢æ¿å·²ç”¨äºå„ç§æ€§èƒ½åˆ†æï¼Œç”±äºå®ƒèƒ½å¤Ÿåœ¨ Node.js ä¸­åˆ†æ JavaScript CPU æ€§èƒ½ï¼Œå› æ­¤æœ‰å¿…è¦å°†æ‰€æœ‰å†…å®¹æ•´åˆåˆ°ä¸€å¤„ï¼Œä»¥ç¡®ä¿ä¸€è‡´æ€§å’Œæ•ˆç‡ã€‚
- **â€œæ€§èƒ½â€é¢æ¿æ›´å¥½**ã€‚æˆ‘ä»¬ä¼šç»§ç»­æ·»åŠ æ–°åŠŸèƒ½å’Œå¢å¼ºåŠŸèƒ½ï¼Œä½¿å…¶æˆä¸ºåŠŸèƒ½æ›´å¼ºå¤§ã€æ›´æ˜“ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·ã€‚

## å¼ƒç”¨åè¯¥æ€ä¹ˆè¿›è¡Œæ€§èƒ½åˆ†æï¼Ÿ

å¦‚éœ€è¯¦ç»†äº†è§£å¦‚ä½•åˆ†æ JavaScript CPU æ€§èƒ½ï¼Œè¯·å‚é˜…[åˆ†æ Node.js æ€§èƒ½](https://developer.chrome.com/docs/devtools/performance/nodejs?hl=zh-cn)ã€‚

ä»¥ä¸‹æ˜¯å…³äºä½¿ç”¨**æ€§èƒ½**é¢æ¿çš„ä¸€äº›æŠ€å·§ï¼š

- ä½¿ç”¨**ç«ç„°å›¾**ç¡®å®šæ€§èƒ½ç“¶é¢ˆã€‚

![ç«ç„°å›¾ã€‚](https://developer.chrome.com/static/blog/profiling-cpu/image/flame-chart.png?hl=zh-cn)

- ä½¿ç”¨ Â **è‡ªä¸‹è€Œä¸Š**Â  å’Œ **è°ƒç”¨æ ‘** æ ‡ç­¾é¡µäº†è§£å‡½æ•°ä¹‹é—´çš„å…³ç³»ã€‚

![â€œè‡ªä¸‹è€Œä¸Šâ€æ ‡ç­¾é¡µã€‚](https://developer.chrome.com/static/blog/profiling-cpu/image/bottom-up.png?hl=zh-cn)

![â€œè°ƒç”¨æ ‘â€æ ‡ç­¾é¡µã€‚](https://developer.chrome.com/static/blog/profiling-cpu/image/call-tree.png?hl=zh-cn)

## æˆ‘ä»¬å°†å¦‚ä½•é€æ­¥å¼ƒç”¨ JavaScript æ€§èƒ½åˆ†æå™¨ï¼Ÿ

æˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªåŸå‹å¹¶åœ¨ GitHub ä¸Šå…¬å¼€å‘å¸ƒäº†[å¾æ±‚æ„è§ç¨¿ (RFC)](https://github.com/ChromeDevTools/rfcs/discussions/2)ï¼Œä»¥å¾æ±‚å¼€å‘è€…çš„åé¦ˆã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šç§¯æè”ç³»å¼€å‘è€…ä¸“å®¶æ¥æµ‹è¯•åŸå‹ï¼Œè§£å†³å„ç§é¡¾è™‘æˆ–é—®é¢˜ï¼Œä»¥ç¡®ä¿**æ€§èƒ½**é¢æ¿æ»¡è¶³æ ¸å¿ƒçš„æ€§èƒ½åˆ†æéœ€æ±‚ã€‚

æˆ‘ä»¬å°†åˆ† Â [4 ä¸ªé˜¶æ®µ](https://github.com/ChromeDevTools/rfcs/discussions/2#discussioncomment-5189668)é€æ­¥åœç”¨ JavaScript æ€§èƒ½åˆ†æå™¨ï¼Œä»¥ä¾¿å¼€å‘è€…æœ‰è¶³å¤Ÿçš„æ—¶é—´è¿›è¡Œè°ƒæ•´å’Œé‡‡ç”¨ã€‚

> è¯‘æ³¨ï¼šåœ¨ Chrome 115 åŠä»¥åï¼Œè¿™å››ä¸ªé˜¶æ®µå·²ç»å…¨éƒ¨å®Œæˆã€‚

## ä¸»è¦é—®é¢˜åŠè§£å†³æ–¹æ³•

åœ¨æˆ‘ä»¬æ”¶åˆ°çš„åé¦ˆä¸­ï¼Œæœ€è¿«åˆ‡çš„æ‹…å¿§ä¸»è¦å›´ç»•ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š

- **æ”¯æŒ Â `.cpuprofile`Â  æ–‡ä»¶æ ¼å¼**ã€‚**JS æ€§èƒ½åˆ†æå™¨**ä½¿ç”¨å¦ä¸€ç§æ–‡ä»¶æ ¼å¼ã€‚**æ€§èƒ½**é¢æ¿åº”æ”¯æŒæ­¤åŠŸèƒ½ã€‚
- **åŠ è½½é€Ÿåº¦ç¼“æ…¢**ã€‚é¢æ¿çš„åŠ è½½é€Ÿåº¦ä¼¼ä¹å¾ˆæ…¢ï¼Œå¹²æ‰°äº†åˆ†æè¿‡ç¨‹ã€‚
- **ç¼ºå°‘ JavaScript è™šæ‹Ÿæœºé€‰æ‹©å™¨ã€‚**åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼ºå°‘ JavaScript è™šæ‹Ÿæœºå®ä¾‹é€‰æ‹©å™¨ä¼šé™åˆ¶åˆ†æåŠŸèƒ½ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªé—®é¢˜ï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚

### åŠ è½½é€Ÿåº¦ç¼“æ…¢

å¼€å‘è€…å‘Šè¯‰æˆ‘ä»¬ï¼Œ**æ€§èƒ½**é¢æ¿åŠ è½½å¤§å‹æ•°æ®æ–‡ä»¶çš„ç”¨æ—¶è¿‡é•¿ï¼Œæœ‰æ—¶ç”šè‡³ä¼šå´©æºƒã€‚

æˆ‘ä»¬ä½¿ç”¨å¼€å‘è€…å·¥å…·åˆ†æå¼€å‘è€…å·¥å…·ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œDevTools-on-DevToolsâ€ï¼‰ã€‚æˆ‘ä»¬å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œå¹¶åšå‡ºäº†å¤šé¡¹ä¼˜åŒ–ï¼š

- å·²å°† Â `Set`Â  æ›¿æ¢ä¸º Â `Array`Â  æ•°æ®ç»“æ„ã€‚
- ç§»é™¤äº†ä¸å¿…è¦çš„ Â `Map`Â  æ•°æ®ç»“æ„ã€‚
- å°†é€’å½’å‡½æ•°é‡æ„ä¸ºè¿­ä»£å‡½æ•°ï¼ˆfor å¾ªç¯ï¼‰ï¼Œä»¥å‡å°‘å†…å­˜å †æ ˆä½¿ç”¨é‡ã€‚

é€šè¿‡ä¿®å¤è¿™äº›ç“¶é¢ˆï¼Œæˆ‘ä»¬å°†å¤§æ–‡ä»¶çš„åŠ è½½é€Ÿåº¦æå‡äº† 80%ï¼ğŸ‰

è¯¦ç»†äº†è§£æˆ‘ä»¬åœ¨è¿™ç¯‡åšæ–‡ä¸­äº†è§£åˆ°çš„ä¿¡æ¯ï¼š[é€šè¿‡æ€§èƒ½æ„ŸçŸ¥åŠŸèƒ½å°†æ€§èƒ½é¢æ¿æé«˜ 400%](https://developer.chrome.com/blog/perf-panel-4x-faster?hl=zh-cn)ã€‚

### ç¼ºå°‘ JavaScript è™šæ‹Ÿæœºé€‰æ‹©å™¨

åˆå§‹åŸå‹ç¼ºå°‘ JavaScript è™šæ‹Ÿæœºé€‰æ‹©å™¨ã€‚å¼€å‘è€…ä½¿ç”¨æ­¤æŠ¥å‘Šæ¥æ·±å…¥äº†è§£å¹¶ä¸“æ³¨äºåˆ†æç‰¹å®šçš„è™šæ‹Ÿæœºå®ä¾‹ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å‘**æ€§èƒ½**é¢æ¿æ·»åŠ äº†ä¸€ä¸ª JavaScript è™šæ‹Ÿæœºé€‰æ‹©å™¨ã€‚å…¶ä¸­æ˜¾ç¤ºäº†æ‰€æœ‰å¯ç”¨çš„ JavaScript è™šæ‹Ÿæœºå®ä¾‹çš„ä¸‹æ‹‰åˆ—è¡¨ã€‚é€‰æ‹©æŸä¸ªå®ä¾‹åï¼Œ**æ€§èƒ½**é¢æ¿ä¼šåŠ è½½è¯¥ç‰¹å®šå®ä¾‹çš„ CPU é…ç½®æ–‡ä»¶ã€‚

![â€œè°ƒç”¨æ ‘â€æ ‡ç­¾é¡µã€‚](https://developer.chrome.com/static/blog/profiling-cpu/image/vm-selector.png?hl=zh-cn)

### æ”¯æŒ Â `cpuprofile`Â  æ–‡ä»¶æ ¼å¼

ä»¥å‰ï¼Œ**æ€§èƒ½**é¢æ¿ä»…æ”¯æŒè·Ÿè¸ªæ–‡ä»¶ï¼Œå³åŒ…å«è·Ÿè¸ªäº‹ä»¶æ•°ç»„çš„ JSON æ–‡ä»¶ã€‚

å¦ä¸€æ–¹é¢ï¼Œ**JavaScript æ€§èƒ½åˆ†æå™¨**Â  æ”¯æŒ CPU é…ç½®æ–‡ä»¶ï¼Œå³æ‰©å±•åä¸º Â `.cpuprofile`Â  ä¸”åŒ…å« JSON å¯¹è±¡çš„æ–‡ä»¶ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
{
    // æ€§èƒ½èŠ‚ç‚¹åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ ¹èŠ‚ç‚¹
    nodes: ProfileNode[];
    // æ€§èƒ½åˆ†æå¼€å§‹æ—¶é—´æˆ³ï¼ˆå¾®ç§’ï¼‰
    startTime: number;
    // æ€§èƒ½åˆ†æç»“æŸæ—¶é—´æˆ³ï¼ˆå¾®ç§’ï¼‰
    endTime: number;
    // é¡¶éƒ¨èŠ‚ç‚¹çš„æ ·æœ¬ ID
    samples?: integer[];
    // ç›¸é‚»æ ·æœ¬ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼ˆå¾®ç§’ï¼‰
    // ç¬¬ä¸€ä¸ª delta æ˜¯ç›¸å¯¹äº profile.startTime çš„
    timeDeltas?: integer[];
}
```

æ–°å·¥ä½œæµä¸åº”é˜»æ­¢å¼€å‘è€…åˆ†æç°æœ‰ Â `cpuprofile`ã€‚å› æ­¤ï¼Œ**æ€§èƒ½**é¢æ¿ç°åœ¨æ”¯æŒè·Ÿè¸ªæ–‡ä»¶å’Œ CPU é…ç½®æ–‡ä»¶ã€‚æ‚¨å¯ä»¥å°† Â `cpuprofile`Â  æ–‡ä»¶å¯¼å…¥åˆ° Â **æ€§èƒ½**é¢æ¿ Â  ä¸­ï¼Œè¯¥æ–‡ä»¶å°†æ­£ç¡®åŠ è½½ã€‚

åœ¨åå°ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹å¯¹è±¡ç»“æ„å·®å¼‚ã€‚å¦‚æœæ–‡ä»¶å†…å®¹ä»¥ Â `{"nodes":[`Â  å¼€å¤´ï¼Œåˆ™è¡¨ç¤ºå®ƒæ˜¯ CPU é…ç½®æ–‡ä»¶ã€‚å¦åˆ™ä¸ºè·Ÿè¸ªæ–‡ä»¶ã€‚

ä¸€æ—¦ç¡®å®šäº†å†…å®¹ç±»å‹ï¼Œæˆ‘ä»¬å°±ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚å¯¹äºè·Ÿè¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šè§£æäº‹ä»¶å¹¶æ„å»ºä¸€ä¸ªæ—¶é—´è½´ã€‚å¯¹äº CPU é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šè§£æ JSON å¯¹è±¡å¹¶æ„å»ºç«ç„°å›¾ã€‚

## æ€»ç»“

æ— è®ºæ˜¯ç½‘ç«™åˆ†æè¿˜æ˜¯ Node.js å’Œ Deno åº”ç”¨çš„ CPU æ€§èƒ½åˆ†æï¼Œä½¿ç”¨**æ€§èƒ½**é¢æ¿éƒ½å¯ä»¥è·å¾—æ›´é¡ºç•…çš„åˆ†æä½“éªŒã€‚

å¦‚æœæ‚¨æœ‰åé¦ˆæˆ–å»ºè®®ï¼Œè¯·ä¸ºæ­¤ Â [bug](https://issues.chromium.org/issues/40235609)Â  æ·»åŠ è¯„è®ºï¼Œæˆ–é€šè¿‡ä»¥ä¸‹æŸç§æ–¹å¼ä¸æˆ‘ä»¬è”ç³»ã€‚

## ä¸‹è½½é¢„è§ˆæ¸ é“

æ‚¨å¯ä»¥è€ƒè™‘å°† ChromeÂ [Canary ç‰ˆ](https://www.google.com/chrome/canary/?hl=zh-cn)ã€[Dev ç‰ˆ](https://www.google.com/chrome/dev/?hl=zh-cn)æˆ– Â [Beta ç‰ˆ](https://www.google.com/chrome/beta/?hl=zh-cn)ç”¨ä½œé»˜è®¤å¼€å‘æµè§ˆå™¨ã€‚é€šè¿‡è¿™äº›é¢„è§ˆæ¸ é“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æœ€æ–°çš„å¼€å‘è€…å·¥å…·åŠŸèƒ½ï¼Œæµ‹è¯•å…ˆè¿›çš„ç½‘ç»œå¹³å° APIï¼Œå¹¶åœ¨ç”¨æˆ·é‡‡å–è¡ŒåŠ¨ä¹‹å‰å‘ç°ç½‘ç«™ä¸Šçš„é—®é¢˜ï¼

## ä¸ Chrome å¼€å‘è€…å·¥å…·å›¢é˜Ÿè”ç³»

ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹è®¨è®ºåšæ–‡ä¸­çš„æ–°åŠŸèƒ½å’Œå˜åŒ–ï¼Œæˆ–è®¨è®ºä¸å¼€å‘è€…å·¥å…·æœ‰å…³çš„ä»»ä½•å…¶ä»–å†…å®¹ã€‚

- é€šè¿‡ Â [crbug.com](https://crbug.com/)Â  æäº¤å»ºè®®æˆ–åé¦ˆã€‚
- ä½¿ç”¨å¼€å‘è€…å·¥å…·ä¸­çš„**æ›´å¤šé€‰é¡¹**Â Â Â ![äº†è§£è¯¦æƒ…](https://developer.chrome.com/static/images/devtools-more.png?hl=zh-cn)Â Â  >Â **å¸®åŠ©**Â >Â **æŠ¥å‘Š DevTools é—®é¢˜**æ¥æŠ¥å‘Šå¼€å‘è€…å·¥å…·é—®é¢˜ã€‚
- å‘æ¨æ–‡å¹¶[@ChromeDevTools](https://twitter.com/intent/tweet?text=@ChromeDevTools)ã€‚
- è¯·åœ¨ [YouTube è§†é¢‘](https://goo.gle/devtools-youtube)æˆ–â€œå¼€å‘è€…å·¥å…·æç¤ºâ€ [YouTube è§†é¢‘](https://goo.gle/devtools-tips)ä¸­ç•™è¨€è¯´æ˜â€œå¼€å‘è€…å·¥å…·çš„æ–°å˜åŒ–â€ã€‚
